# Pre-commit hooks configuration
# See https://pre-commit.com for more information

default_stages: [commit]
fail_fast: false

repos:
  # ==================== General File Checks ====================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Prevent giant files from being committed
      - id: check-added-large-files
        args: ['--maxkb=1000']
      
      # Check for files that would conflict in case-insensitive filesystems
      - id: check-case-conflict
      
      # Check for merge conflicts
      - id: check-merge-conflict
      
      # Check for debugger imports and py37+ breakpoint()
      - id: debug-statements
      
      # Checks for symlinks which do not point to anything
      - id: check-symlinks
      
      # Check for files that contain merge conflict strings
      - id: check-merge-conflict
      
      # Ensure files end with a newline
      - id: end-of-file-fixer
        exclude: '^(\.idea/|\.vscode/)'
      
      # Trims trailing whitespace
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: '^(\.idea/|\.vscode/)'
      
      # Check JSON files are valid
      - id: check-json
        exclude: '^(\.vscode/|tsconfig\.json)'
      
      # Check YAML files are valid
      - id: check-yaml
        args: ['--unsafe']
        exclude: '^(\.github/workflows/)'
      
      # Check TOML files are valid
      - id: check-toml
      
      # Ensure Python files have valid syntax
      - id: check-ast
      
      # Sort Python requirements files
      - id: requirements-txt-fixer
        files: requirements.*\.txt$

  # ==================== Secret Detection ====================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: |
          (?x)^(
            .*\.lock$|
            package-lock\.json$|
            poetry\.lock$|
            \.env\.example$
          )$

  # ==================== Python: Black Formatter ====================
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        language_version: python3.11
        args: ['--line-length=88']
        files: ^apps/adapter/.*\.py$

  # ==================== Python: Ruff Linter ====================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.11
    hooks:
      - id: ruff
        args: ['--fix', '--exit-non-zero-on-fix']
        files: ^apps/adapter/.*\.py$

  # ==================== Python: mypy Type Checker ====================
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        files: ^apps/adapter/src/.*\.py$
        args: ['--config-file=apps/adapter/pyproject.toml']
        additional_dependencies:
          - types-requests
          - types-redis
          - pydantic
          - sqlalchemy

  # ==================== Python: Import Sorting ====================
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: isort (python)
        args: ['--profile=black', '--line-length=88']
        files: ^apps/adapter/.*\.py$

  # ==================== Python: Docstring Checks ====================
  - repo: https://github.com/pycqa/pydocstyle
    rev: 6.3.0
    hooks:
      - id: pydocstyle
        files: ^apps/adapter/src/.*\.py$
        args: ['--ignore=D100,D101,D102,D103,D104,D105,D107,D203,D213']

  # ==================== Python: Security Checks ====================
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        args: ['-c', 'apps/adapter/pyproject.toml']
        files: ^apps/adapter/.*\.py$
        exclude: ^apps/adapter/tests/

  # ==================== TypeScript/JavaScript: ESLint ====================
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v8.56.0
    hooks:
      - id: eslint
        files: ^apps/web/.*\.(ts|tsx|js|jsx)$
        types: [file]
        args: ['--fix', '--max-warnings=0']
        additional_dependencies:
          - eslint@^8.55.0
          - eslint-config-next@^14.0.4
          - '@typescript-eslint/eslint-plugin@^6.15.0'
          - '@typescript-eslint/parser@^6.15.0'

  # ==================== TypeScript/JavaScript: Prettier ====================
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v3.1.0
    hooks:
      - id: prettier
        files: ^apps/web/.*\.(ts|tsx|js|jsx|json|css|scss|md)$
        args: ['--write']
        exclude: |
          (?x)^(
            apps/web/\.next/|
            apps/web/node_modules/|
            apps/web/package-lock\.json$
          )$

  # ==================== TypeScript: Type Checker ====================
  - repo: local
    hooks:
      - id: tsc
        name: TypeScript Type Check
        entry: bash -c 'cd apps/web && npm run type-check'
        language: system
        files: ^apps/web/.*\.(ts|tsx)$
        pass_filenames: false

  # ==================== Markdown Linting ====================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.38.0
    hooks:
      - id: markdownlint
        args: ['--fix']
        exclude: '^(node_modules/|\.next/)'

  # ==================== YAML Linting ====================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.33.0
    hooks:
      - id: yamllint
        args: ['-d', '{extends: default, rules: {line-length: {max: 120}, document-start: disable}}']

  # ==================== Dockerfile Linting ====================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.12.0
    hooks:
      - id: hadolint-docker
        args: ['--ignore', 'DL3008', '--ignore', 'DL3009', '--ignore', 'DL3015']

  # ==================== Shell Script Checks ====================
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.6
    hooks:
      - id: shellcheck
        args: ['--severity=warning']

  # ==================== Git Commit Message Linting ====================
  - repo: https://github.com/commitizen-tools/commitizen
    rev: 3.13.0
    hooks:
      - id: commitizen
        stages: [commit-msg]

  # ==================== SQL Formatting ====================
  - repo: https://github.com/sqlfluff/sqlfluff
    rev: 2.3.5
    hooks:
      - id: sqlfluff-lint
        files: \.sql$
        args: ['--dialect', 'postgres']
      - id: sqlfluff-fix
        files: \.sql$
        args: ['--dialect', 'postgres']

  # ==================== Local Custom Hooks ====================
  - repo: local
    hooks:
      # Python: Run tests
      - id: pytest-check
        name: pytest-check
        entry: bash -c 'cd apps/adapter && poetry run pytest tests/ -v --tb=short'
        language: system
        pass_filenames: false
        files: ^apps/adapter/.*\.py$
        stages: [push]

      # Node: Run tests
      - id: npm-test
        name: npm-test
        entry: bash -c 'cd apps/web && npm test -- --passWithNoTests'
        language: system
        pass_filenames: false
        files: ^apps/web/.*\.(ts|tsx)$
        stages: [push]

      # Check for TODO/FIXME comments
      - id: check-todos
        name: Check for TODO/FIXME
        entry: bash -c 'git diff --cached --name-only | xargs grep -n "TODO\|FIXME" && echo "Found TODO/FIXME comments. Please address them." || true'
        language: system
        pass_filenames: false
        stages: [commit]

      # Verify no secrets in environment files
      - id: check-env-vars
        name: Check env files for secrets
        entry: bash -c 'git diff --cached --name-only | grep -E "\\.env$$" || true'
        language: system
        pass_filenames: false

      # Ensure migrations are properly named
      - id: migration-naming
        name: Check migration file naming
        entry: bash -c 'git diff --cached --name-only | grep "alembic/versions/" | grep -E "^[0-9]{3}_[a-z_]+\.py$" || true'
        language: system
        pass_filenames: false

# Configuration for CI
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit.com hooks
    
    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: []
  submodules: false