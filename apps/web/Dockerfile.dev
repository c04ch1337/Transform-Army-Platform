# Development Dockerfile for Next.js web application
# Optimized for fast rebuilds with volume mounts
FROM node:18-alpine

WORKDIR /app

# Install dependencies for node-gyp and native modules
RUN apk add --no-cache python3 make g++ wget

# Create non-root user for security
# Check if group exists, if not create it. node:alpine already has node user.
RUN if ! getent group appuser; then \
        addgroup -S appuser; \
    fi && \
    if ! getent passwd appuser; then \
        adduser -S -G appuser appuser; \
    fi && \
    chown -R appuser:appuser /app

# Copy only package files for dependency installation
# This layer is cached unless package.json changes
COPY --chown=appuser:appuser package*.json ./

# Switch to non-root user
USER appuser

# Install dependencies using npm (not pnpm - not installed in container)
RUN npm install

# Note: Application code is mounted as a volume in docker-compose.dev.yml
# This allows for hot-reloading without rebuilding the container
# The COPY below is for standalone use, but gets overridden by volume mount

# Copy application code (overridden by volume mount in development)
COPY --chown=appuser:appuser . .

# Expose Next.js development server port
EXPOSE 3000

# Health check - accounts for slow Next.js startup in development
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1

# Run Next.js in development mode with hot reloading
# Uses npm to match package manager in package.json
CMD ["npm", "run", "dev"]