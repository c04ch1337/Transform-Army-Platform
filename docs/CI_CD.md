# CI/CD Pipeline Documentation

## Overview

Transform Army AI uses GitHub Actions for comprehensive CI/CD automation, covering testing, security scanning, deployment, and dependency management.

## Table of Contents

- [Workflows](#workflows)
- [Getting Started](#getting-started)
- [Environment Setup](#environment-setup)
- [Workflow Details](#workflow-details)
- [Deployment Procedures](#deployment-procedures)
- [Rollback Procedures](#rollback-procedures)
- [Troubleshooting](#troubleshooting)
- [Best Practices](#best-practices)

---

## Workflows

| Workflow | File | Trigger | Purpose |
|----------|------|---------|---------|
| **CI Pipeline** | [`ci.yml`](../.github/workflows/ci.yml) | Push, PR | Lint, test, build |
| **Security Scans** | [`security.yml`](../.github/workflows/security.yml) | Push, PR, Schedule | Vulnerability scanning |
| **Deployment** | [`deploy.yml`](../.github/workflows/deploy.yml) | Tag creation | Deploy to staging/production |
| **Database Migrations** | [`migrations.yml`](../.github/workflows/migrations.yml) | Migration changes | Validate and run migrations |
| **Dependency Updates** | [`dependency-updates.yml`](../.github/workflows/dependency-updates.yml) | Weekly/Manual | Update dependencies |

---

## Getting Started

### Prerequisites

1. GitHub repository with Actions enabled
2. Required secrets configured (see [Environment Setup](#environment-setup))
3. Branch protection rules configured for `main` and `develop`

### Initial Setup

```bash
# 1. Enable GitHub Actions in repository settings
# 2. Configure required secrets (see next section)
# 3. Set up environments: staging, production, production-approval
# 4. Configure branch protection rules
```

---

## Environment Setup

### Required Secrets

Configure these secrets in GitHub repository settings (`Settings > Secrets and variables > Actions`):

#### **Repository Secrets**

| Secret | Description | Required For |
|--------|-------------|--------------|
| `CODECOV_TOKEN` | Codecov upload token | CI Pipeline |
| `GITHUB_TOKEN` | Auto-generated by GitHub | All workflows |
| `SLACK_WEBHOOK` | Slack notification webhook | Deployments |

#### **Environment Secrets**

**Staging Environment:**
- `KUBE_CONFIG_STAGING` - Base64-encoded kubeconfig for staging cluster

**Production Environment:**
- `KUBE_CONFIG_PRODUCTION` - Base64-encoded kubeconfig for production cluster

### Environment Configuration

Create three environments in GitHub:

1. **staging** - Automatic deployment after CI passes
2. **production-approval** - Manual approval gate
3. **production** - Production deployment with required reviewers

```bash
# Configure environments:
# Repository Settings > Environments > New environment
```

---

## Workflow Details

### 1. CI Pipeline

**File:** [`.github/workflows/ci.yml`](../.github/workflows/ci.yml)

**Triggers:**
- Push to `main` or `develop` branches
- Pull requests to `main` or `develop`

**Jobs:**

#### Lint Python Backend
```yaml
- Installs Poetry and dependencies
- Runs Ruff linter
- Runs Black formatter check
- Runs mypy type checker
```

#### Lint TypeScript Frontend
```yaml
- Installs pnpm and dependencies
- Runs ESLint
- Runs TypeScript type check
```

#### Test Backend
```yaml
- Starts PostgreSQL and Redis services
- Runs pytest with coverage
- Uploads coverage to Codecov
```

#### Test Frontend
```yaml
- Runs Jest tests with coverage
- Uploads coverage to Codecov
```

#### Build Docker Images
```yaml
- Builds Docker images for adapter and web
- Uses BuildKit caching for speed
- Validates images can be built successfully
```

**Success Criteria:**
- All linting checks pass
- Test coverage meets thresholds (85%+)
- Docker images build successfully

---

### 2. Security Scans

**File:** [`.github/workflows/security.yml`](../.github/workflows/security.yml)

**Triggers:**
- Push to `main` or `develop`
- Pull requests
- Daily at 2 AM UTC
- Manual dispatch

**Jobs:**

#### Python Dependencies
```bash
# Scans Python dependencies for vulnerabilities
pip-audit --requirement requirements.txt
```

#### Node Dependencies
```bash
# Scans Node dependencies for vulnerabilities
npm audit
```

#### Secret Scanning
```bash
# Scans for exposed secrets in code
TruffleHog OSS
```

#### Docker Image Scanning
```bash
# Scans Docker images for vulnerabilities
Trivy (Critical and High severity)
```

#### SAST Analysis
```bash
# Static Application Security Testing
Semgrep (auto-config)
CodeQL (security-extended queries)
```

#### Security Audit Script
```bash
# Custom security checks
./scripts/security-audit.sh
```

**Reports:**
- SARIF files uploaded to GitHub Security tab
- JSON artifacts stored for 30 days
- Summary posted to GitHub Actions

---

### 3. Deployment

**File:** [`.github/workflows/deploy.yml`](../.github/workflows/deploy.yml)

**Triggers:**
- Tag creation matching `v*.*.*` (e.g., `v1.0.0`)
- Manual dispatch with environment selection

**Deployment Flow:**

```
Build Images → Deploy Staging → Smoke Tests → Approval → Deploy Production → Verify
```

#### Stage 1: Build Production Images
```yaml
- Builds Docker images
- Tags with version and SHA
- Pushes to GitHub Container Registry
- Uses layer caching for efficiency
```

#### Stage 2: Deploy to Staging
```yaml
- Updates Kubernetes deployments
- Runs database migrations
- Verifies rollout status
- Generates deployment summary
```

#### Stage 3: Smoke Tests (Staging)
```yaml
- Health check endpoints
- API endpoint tests
- Database connectivity tests
- Frontend loading tests
```

#### Stage 4: Production Approval
```yaml
- Manual approval required
- Review staging deployment
- Environment: production-approval
```

#### Stage 5: Deploy to Production
```yaml
- Creates deployment backups
- Updates Kubernetes deployments
- Runs database migrations
- Verifies rollout status
- Uploads backup artifacts
```

#### Stage 6: Verify Production
```yaml
- Health checks
- Critical path tests
- Performance checks
- Sends notifications
```

#### Automatic Rollback
```yaml
- Triggers on deployment failure
- Reverts to previous version
- Sends alert notifications
```

---

### 4. Database Migrations

**File:** [`.github/workflows/migrations.yml`](../.github/workflows/migrations.yml)

**Triggers:**
- Changes to migration files
- Changes to model files
- Manual dispatch with action selection

**Jobs:**

#### Check for Conflicts
```bash
# Detects migration branches and multiple heads
alembic branches
alembic heads
```

#### Validate Schema Consistency
```bash
# Ensures models match migrations
alembic check
# Tests migration up/down
alembic upgrade head
alembic downgrade -1
alembic upgrade head
```

#### Generate Migration Graph
```bash
# Creates visual representation
alembic history --verbose
```

#### Execute Migration (Manual)
```yaml
Actions:
  - check: Check current status
  - upgrade: Upgrade to target
  - downgrade: Downgrade to target
  - generate: Auto-generate migration
```

---

### 5. Dependency Updates

**File:** [`.github/workflows/dependency-updates.yml`](../.github/workflows/dependency-updates.yml)

**Triggers:**
- Weekly on Mondays at 9 AM UTC
- Manual dispatch with update type

**Update Types:**

#### Security Updates
```yaml
- Applies fixes for known vulnerabilities
- Auto-creates PR with "security" label
- High priority for review
```

#### Minor Updates
```yaml
- Updates to latest minor versions
- Non-breaking changes only
- Auto-creates PR with "enhancement" label
```

#### All Updates
```yaml
- Updates to latest versions (including major)
- May include breaking changes
- Requires thorough review
- Label: "breaking-change"
```

**Process:**
1. Check for outdated packages
2. Apply updates based on type
3. Run tests on updated dependencies
4. Create pull request
5. License compliance check

---

## Deployment Procedures

### Standard Release

1. **Create Release Tag**
   ```bash
   git tag -a v1.0.0 -m "Release v1.0.0"
   git push origin v1.0.0
   ```

2. **Monitor Deployment**
   - Go to Actions tab in GitHub
   - Watch deployment workflow progress
   - Check staging deployment

3. **Verify Staging**
   ```bash
   # Health check
   curl https://staging.transform-army.ai/health
   
   # Test critical paths
   # Verify database migrations
   ```

4. **Approve Production**
   - Review staging deployment
   - Approve in GitHub Actions UI
   - Monitor production deployment

5. **Verify Production**
   ```bash
   # Health check
   curl https://transform-army.ai/health
   
   # Check all critical paths
   # Monitor metrics and logs
   ```

### Hotfix Release

1. **Create Hotfix Branch**
   ```bash
   git checkout -b hotfix/v1.0.1 main
   # Make fixes
   git commit -m "fix: critical bug"
   ```

2. **Tag and Deploy**
   ```bash
   git tag -a v1.0.1 -m "Hotfix v1.0.1"
   git push origin v1.0.1
   ```

3. **Fast-track Approval**
   - Minimal staging testing
   - Expedited production approval
   - Enhanced monitoring

### Manual Deployment

1. **Trigger Workflow**
   ```yaml
   # Go to Actions > Deploy > Run workflow
   # Select environment: staging or production
   # Enter version tag
   # Click "Run workflow"
   ```

2. **Monitor and Verify**
   - Watch workflow progress
   - Check deployment logs
   - Verify services

---

## Rollback Procedures

### Automatic Rollback

If deployment verification fails, automatic rollback occurs:

```bash
# Kubernetes automatically reverts
kubectl rollout undo deployment/adapter -n production
kubectl rollout undo deployment/web -n production
```

### Manual Rollback

#### Method 1: Using Kubernetes

```bash
# View rollout history
kubectl rollout history deployment/adapter -n production

# Rollback to previous version
kubectl rollout undo deployment/adapter -n production
kubectl rollout undo deployment/web -n production

# Rollback to specific revision
kubectl rollout undo deployment/adapter -n production --to-revision=2
```

#### Method 2: Redeploy Previous Tag

```bash
# Find previous working version
git tag -l "v*" | sort -V

# Redeploy that version
gh workflow run deploy.yml -f environment=production -f version=v1.0.0
```

#### Method 3: Use Backup Deployments

```bash
# Download backup from GitHub Actions artifacts
# Apply backup configuration
kubectl apply -f backup-adapter-20240101-120000.yaml -n production
kubectl apply -f backup-web-20240101-120000.yaml -n production
```

### Database Rollback

```bash
# SSH to adapter pod
kubectl exec -it deployment/adapter -n production -- bash

# Rollback migration
alembic downgrade -1

# Verify
alembic current
```

---

## Troubleshooting

### Common Issues

#### CI Pipeline Failures

**Linting Errors:**
```bash
# Run locally before pushing
make lint
make format

# Fix specific issues
cd apps/adapter && poetry run ruff check --fix .
cd apps/web && pnpm lint:fix
```

**Test Failures:**
```bash
# Run tests locally
make test

# Run with verbose output
cd apps/adapter && poetry run pytest -v
cd apps/web && pnpm test
```

**Build Failures:**
```bash
# Test Docker build locally
docker build -t test apps/adapter
docker build -t test apps/web

# Check for dependency issues
cd apps/adapter && poetry install
cd apps/web && pnpm install
```

#### Deployment Issues

**Failed Staging Deployment:**
1. Check Kubernetes cluster status
2. Verify image tags are correct
3. Check secrets and config maps
4. Review pod logs

```bash
kubectl get pods -n staging
kubectl logs deployment/adapter -n staging
kubectl describe pod <pod-name> -n staging
```

**Failed Database Migration:**
1. Check migration conflicts
2. Verify database connectivity
3. Manually run migration

```bash
kubectl exec deployment/adapter -n staging -- alembic current
kubectl exec deployment/adapter -n staging -- alembic upgrade head
```

**Image Pull Errors:**
```bash
# Verify image exists in registry
docker pull ghcr.io/<owner>/transform-army-adapter:v1.0.0

# Check registry credentials
kubectl get secret regcred -n production
```

#### Security Scan Issues

**False Positives:**
1. Review vulnerability details
2. Check if actually exploitable
3. Add to suppression file if safe

**High Severity Vulnerabilities:**
1. Check for available patches
2. Update dependencies immediately
3. Consider temporary mitigation

### Getting Help

1. **Check Workflow Logs:**
   - Go to Actions tab
   - Click on failed workflow
   - Review job logs

2. **GitHub Issues:**
   - Create issue with workflow link
   - Include error messages
   - Tag with `ci/cd` label

3. **Local Reproduction:**
   ```bash
   # Install act for local testing
   brew install act
   
   # Run workflow locally
   act -W .github/workflows/ci.yml
   ```

---

## Best Practices

### Code Quality

1. **Run checks before pushing:**
   ```bash
   make lint
   make test
   make type-check
   ```

2. **Use pre-commit hooks:**
   ```bash
   pre-commit install
   pre-commit run --all-files
   ```

3. **Keep dependencies updated:**
   - Review dependency update PRs weekly
   - Prioritize security updates
   - Test thoroughly before merging

### Deployment

1. **Always deploy to staging first**
2. **Run smoke tests before production**
3. **Deploy during low-traffic periods**
4. **Have rollback plan ready**
5. **Monitor metrics during deployment**

### Security

1. **Never commit secrets**
2. **Review security scan results**
3. **Keep dependencies updated**
4. **Use least privilege access**
5. **Rotate secrets regularly**

### Documentation

1. **Document all configuration changes**
2. **Update runbooks for new features**
3. **Keep deployment procedures current**
4. **Document incident responses**

---

## CI/CD Metrics

### Key Performance Indicators

- **Build Time:** < 15 minutes
- **Test Coverage:** > 85%
- **Deployment Frequency:** Multiple times per day
- **Mean Time to Recovery (MTTR):** < 1 hour
- **Change Failure Rate:** < 15%

### Monitoring

Track these metrics in your CI/CD dashboard:

1. Workflow success rate
2. Average build duration
3. Time from commit to deployment
4. Security vulnerability trends
5. Dependency update frequency

---

## Additional Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [Kubernetes Deployment Strategies](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/)
- [Alembic Migrations](https://alembic.sqlalchemy.org/en/latest/)

---

## Status Badges

Add these badges to your README for visibility:

```markdown
![CI Pipeline](https://github.com/<owner>/<repo>/actions/workflows/ci.yml/badge.svg)
![Security Scans](https://github.com/<owner>/<repo>/actions/workflows/security.yml/badge.svg)
![Deployment](https://github.com/<owner>/<repo>/actions/workflows/deploy.yml/badge.svg)
[![codecov](https://codecov.io/gh/<owner>/<repo>/branch/main/graph/badge.svg)](https://codecov.io/gh/<owner>/<repo>)
```

---

**Last Updated:** 2024-11-02  
**Version:** 1.0.0  
**Maintained By:** Transform Army AI Team